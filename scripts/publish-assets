#!/bin/bash
# Publish demo assets to the worktrunk-assets repo
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
ASSETS_REPO="$REPO_ROOT/../worktrunk-assets"

# Demo sources: name|source_path
# Both light and dark variants for theme switching
DEMOS=(
    "wt-demo.gif|$REPO_ROOT/docs/demos/wt/out/wt-demo.gif"
    "wt-demo-dark.gif|$REPO_ROOT/docs/demos/wt/out/wt-demo-dark.gif"
    "wt-select.gif|$REPO_ROOT/docs/demos/wt-select/out/wt-select.gif"
    "wt-select-dark.gif|$REPO_ROOT/docs/demos/wt-select/out/wt-select-dark.gif"
)

# Clone assets repo if needed
if [[ ! -d "$ASSETS_REPO/.git" ]]; then
    if ! command -v gh &>/dev/null; then
        echo "Error: gh CLI required. Install from https://cli.github.com/"
        exit 1
    fi
    echo "Cloning assets repo..."
    if ! gh repo clone max-sixty/worktrunk-assets "$ASSETS_REPO"; then
        echo "Failed to clone assets repo"
        exit 1
    fi
fi

# Update assets repo
cd "$ASSETS_REPO"
if ! git pull --ff-only; then
    echo "Failed to update assets repo. Check for uncommitted changes."
    exit 1
fi

# Copy available assets
echo "Copying assets..."
copied=()
for entry in "${DEMOS[@]}"; do
    name="${entry%%|*}"
    src="${entry#*|}"
    if [[ -f "$src" ]]; then
        cp "$src" "$ASSETS_REPO/demos/"
        copied+=("$name")
        echo "  $name"
    fi
done

if [[ ${#copied[@]} -eq 0 ]]; then
    echo "No demo GIFs found. Build them first:"
    echo "  ./docs/demos/wt/build"
    echo "  ./docs/demos/wt-select/build"
    exit 1
fi

# Check for changes
if git diff --quiet demos/; then
    echo "No changes to publish"
    exit 0
fi

# Show what changed
echo ""
echo "Changes:"
git diff --stat demos/

# Commit and push
git add demos/
git commit -m "Update demo assets"
git push

echo ""
echo "Published:"
for name in "${copied[@]}"; do
    echo "  https://raw.githubusercontent.com/max-sixty/worktrunk-assets/main/demos/$name"
done
echo ""
echo "CDN (~1 min to update):"
for name in "${copied[@]}"; do
    echo "  https://cdn.jsdelivr.net/gh/max-sixty/worktrunk-assets@main/demos/$name"
done
